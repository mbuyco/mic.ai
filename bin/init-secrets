#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SECRETS_DIR="$ROOT_DIR/secrets"

umask 077
mkdir -p "$SECRETS_DIR"

write_if_missing() {
  local file="$1"
  local value="$2"
  if [[ ! -f "$file" ]]; then
    printf '%s' "$value" >"$file"
    chmod 644 "$file"
    echo "Created $file"
  else
    echo "Exists   $file"
  fi
}

if command -v openssl >/dev/null 2>&1; then
  ADMIN_KEY="$(openssl rand -hex 24)"
else
  ADMIN_KEY="change-me-admin-key"
fi

write_if_missing "$SECRETS_DIR/admin_api_key" "$ADMIN_KEY"
write_if_missing "$SECRETS_DIR/whatsapp_verify_token" "change-me-verify-token"
write_if_missing "$SECRETS_DIR/whatsapp_access_token" "change-me-access-token"
write_if_missing "$SECRETS_DIR/whatsapp_phone_number_id" "change-me-phone-number-id"

"$ROOT_DIR/bin/ensure-secrets-perms"

echo
echo "Edit any 'change-me-*' values in '$SECRETS_DIR' before enabling outbound sends."
echo "Permissions are normalized for rootless Podman compatibility."
