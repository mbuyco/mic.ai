#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 1 ]]; then
  echo "Usage: $0 <render-api-url> [verify-token]"
  echo "Example: $0 https://micai-api.onrender.com \$MICAI_WHATSAPP_VERIFY_TOKEN"
  exit 1
fi

base_url="${1%/}"
verify_token="${2:-${MICAI_WHATSAPP_VERIFY_TOKEN:-}}"
challenge="micai-check-$(date +%s)"

echo "Checking health endpoint..."
curl --fail --silent --show-error "$base_url/health" | python -m json.tool

if [[ -z "$verify_token" ]]; then
  echo "Skipping webhook verification check (no token provided)."
  exit 0
fi

echo "Checking webhook verification endpoint..."
response="$(curl --fail --silent --show-error "$base_url/webhook?hub.mode=subscribe&hub.verify_token=$verify_token&hub.challenge=$challenge")"

if [[ "$response" != "$challenge" ]]; then
  echo "Webhook verification failed: expected '$challenge' got '$response'"
  exit 2
fi

echo "Webhook verification ok."
